
## Взаимодействие основных компонентов платформы OpenStack

### OpenStack – это облачная платформа для развертывания и управления облачными инфраструктурами. Она состоит из нескольких ключевых компонентов, каждый из которых отвечает за определённые функции.  

### 

----------

## **1. Основные компоненты OpenStack**

### **1.1. Nova (Compute)**

**Nova** — это компонент, отвечающий за управление виртуальными машинами (VM) в OpenStack. Он предоставляет API для запуска, остановки и масштабирования инстансов.

-   Поддерживает различные гипервизоры: KVM, QEMU, Xen, VMware и др.
-   Взаимодействует с другими компонентами (Neutron, Cinder, Keystone).
-   Обеспечивает управление распределёнными ресурсами (Scheduler).

----------

### **1.2. Neutron (Networking)**

**Neutron** отвечает за настройку и управление сетями внутри OpenStack.

-   Позволяет создавать частные и публичные сети, виртуальные маршрутизаторы и балансировщики нагрузки.
-   Поддерживает  плагины SDN (Software Defined Networking).
-   Взаимодействует с Nova для подключения инстансов к сети.

----------

### **1.3. Cinder (Block Storage)**

**Cinder** — это сервис блочного хранения, который предоставляет виртуальные диски (тома) для инстансов.

-   Позволяет создавать, удалять и подключать тома к виртуальным машинам.
-   Поддерживает различные бэкенды: LVM, Ceph, NetApp, EMC и др.
-   Интегрируется с Nova, обеспечивая постоянное хранилище для VM.

----------

### **1.4. Keystone (Identity Service)**

**Keystone** — это сервис аутентификации и авторизации пользователей в OpenStack.

-   Поддерживает различные механизмы аутентификации (пароли, LDAP, токены).
-   Реализует многоуровневую авторизацию на основе ролей (RBAC).
-   Обеспечивает централизованное управление пользователями и сервисами.

----------

### **1.5. Glance (Image Service)**

**Glance** — сервис управления образами виртуальных машин.

-   Позволяет хранить и управлять образами (QCOW2, RAW, VMDK и др.).
-   Обеспечивает интеграцию с Cinder и Swift.
-   Поддерживает загрузку и раздачу образов через API.

----------

### **1.6. Horizon (Dashboard)**

**Horizon** — веб-интерфейс OpenStack.

-   Позволяет управлять всеми сервисами через GUI.
-   Поддерживает мультитенантность и разграничение прав.
-   Упрощает администрирование и мониторинг облака.

----------

### **1.7. Swift (Object Storage)**

**Swift** — распределённое объектное хранилище.

-   Предназначено для хранения больших объёмов данных (бэкапы, медиафайлы, архивы).
-   Использует архитектуру без единой точки отказа (replication, erasure coding).
-   Интегрируется с Glance и другими сервисами OpenStack.

----------

### **1.8. Heat (Orchestration)**

**Heat** — сервис  оркестрации  ресурсов.

-   Позволяет описывать инфраструктуру как код (Infrastructure-as-Code, IaC) с помощью YAML-шаблонов (Heat Orchestration Template — HOT).
-   Поддерживает автоматизированное развертывание и масштабирование.
-   Интегрируется с Nova, Neutron, Cinder и другими сервисами.

----------

### **1.9. Ceilometer (Telemetry)**

**Ceilometer** — сервис мониторинга и учёта потребления ресурсов.

-   Собирает метрики производительности, потребления CPU, RAM, трафика.
-   Интегрируется с внешними системами биллинга.
-   Может использоваться для автоскейлинга ресурсов.

----------

### **1.10. Trove (Database-as-a-Service)**

**Trove** — сервис управления базами данных.

-   Поддерживает автоматическое развертывание и управление MySQL, PostgreSQL, MongoDB и другими СУБД.
-   Обеспечивает масштабируемость и отказоустойчивость баз данных.
-   Упрощает развертывание базовых сервисов для облачных приложений.
## **Схема взаимодействия компонентов OpenStack**
![enter image description here]()
----------
## **2. Архитектура OpenStack**

OpenStack имеет распределённую архитектуру с несколькими узлами:

1.  **Контроллер (Controller Node)** — управляет аутентификацией (Keystone), образами (Glance), API-компонентами и оркестрацией.
2.  **Вычислительные узлы (Compute Nodes)** — хостят виртуальные машины и управляют их жизненным циклом через Nova.
3.  **Сетевые узлы (Network Nodes)** — управляют маршрутизацией, NAT, VPN и балансировкой нагрузки через Neutron.
4.  **Узлы хранения (Storage Nodes)** — хранят данные в Swift (объектное хранилище) или Cinder (блочное хранилище).

----------
  
## Cloud-init: назначение и роль

**Cloud-init** – это инструмент для инициализации виртуальных машин при их первом запуске. Он используется в OpenStack и других облачных платформах для автоматической настройки ВМ.

**Функции Cloud-init**

-   Автоматическая настройка пользователей (создание пользователей, установка паролей, настройка SSH-ключей).
-   Настройка сети.
-   Запуск скриптов (Bash, Python и др.) при старте ВМ.
-   Установка и настройка программного обеспечения.
-   Изменение параметров ОС (например, hostname).

**Как работает Cloud-init?**

1.  При создании ВМ OpenStack передаёт метаданные в **metadata service**.
2.  **Cloud-init**, запущенный в ВМ, запрашивает эти данные.
3.  Выполняются скрипты и настройки на основе полученной информации.

**Пример использования Cloud-init:**

    #cloud-config
    users:
      - name: newuser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        shell: /bin/bash
        ssh-authorized-keys:
          - ssh-rsa AAAAB3Nza...


Таким образом, Cloud-init позволяет автоматизировать развертывание ВМ, снижая необходимость ручной настройки.

### **Создание инстанса в OpenStack** через веб-интерфейс  **Horizon**.

----------

### **Шаг 1: Вход в панель управления OpenStack (Horizon)**

1.  Открыть веб-браузер и перейти по адресу **Horizon Dashboard** (обычно `http://<openstack-dashboard-url>`).
2.  Ввести **логин** и **пароль** пользователя.
3.  Нажать **"Войти"**.

----------

### **Шаг 2: Переход в раздел запуска инстанса**

1.  В левой панели выбрать **"Вычисления" → "Инстансы"**.
2.  Нажать кнопку **"Запустить инстанс"**.

----------

### **Шаг 3: Настройка параметров инстанса**

Откроется окно с вкладками для настройки инстанса.

#### **1. Основные параметры**

-   **Имя инстанса** – ввести уникальное имя.
-   **Количество инстансов** – выбрать количество копий ВМ (обычно 1).

#### **2. Источник (образ ОС)**

Выбор одного из источников:

-   **Образ** – выбрать готовый образ операционной системы (например, Ubuntu 22.04).
-   **Снимок** – выбрать сохранённый снимок другой ВМ (если требуется).
-   **Том (Cinder)** – использовать существующий том в качестве загрузочного диска.

#### **3. Размер инстанса (Flavor)**

Выбрать конфигурацию (количество vCPU, RAM, дисковое пространство), например:

-   `IAAS_vCPU_1_RAM_2_disk_20` – 1 vCPU, 2 ГБ RAM, 20 ГБ  диск.

#### **4. Сеть**

-   Выбрать доступную виртуальную сеть.
-   (Опционально) Добавить **плавающий IP** для внешнего доступа.

#### **5. Ключ SSH**

-   Выбрать существующий SSH-ключ или создать новый для безопасного доступа к ВМ.

#### **6. Группы безопасности**

-   Добавить **security group**, которая разрешает нужные подключения (например, `default`, `allow-ssh`).

#### **7. Дополнительные параметры (Cloud-init, пользовательские скрипты)**

-   В разделе **"Дополнительные параметры"** можно добавить Cloud-init скрипт для автоматической настройки ВМ.

----------

### **Шаг 4: Запуск инстанса**

1.  Проверить все параметры.
2.  Нажать **"Запустить инстанс"**.
3.  Перейти в раздел **"Вычисления" → "Инстансы"** и убедиться, что статус инстанса **"Выполняется"** (Running).

----------

### **Шаг 5: Подключение к инстансу**

#### **1. Если есть плавающий IP:**

-   Подключиться к серверу по SSH:

```
ssh -i my_key.pem user@<floating_ip>
```

#### **2. Если IP нет (консольный доступ через Horizon):**

-   В разделе **"Инстансы"** нажать **"Консоль"** и войти в систему.

----------

Инстанс успешно создан и готов к работе. При необходимости можно установить дополнительные пакеты, настроить брандмауэр и выполнить другие действия.

### **Cоздание инстанса в OpenStack через CLI:**

----------

### **Шаг 1: Установка OpenStack CLI (если не установлен)**

Если CLI-клиент OpenStack еще не установлен, выполнить:

#### **Ubuntu/Debian:**

```
sudo apt update
```

```
sudo apt install python3-openstackclient -y
```

#### **CentOS/RHEL:**

```
sudo dnf install python3-openstackclient -y
```

#### **macOS:**

```
brew install openstackclient
```

----------

### **Шаг 2: Аутентификация в OpenStack**

Перед выполнением команд нужно загрузить переменные окружения для подключения.

1.  Скачать файл **RC-файл OpenStack** из Horizon (**Проект → Доступ к API → Скачать OpenStack RC-файл**).
2.  Выполнить команду для загрузки переменных (заменить `<rc-file.sh>` на реальное имя файла):

source `<rc-file.sh>`

3.  Ввести пароль при запросе.

Проверить подключение:

```
openstack server list
```

Если подключение успешно, отобразится список существующих инстансов.

----------

### **Шаг 3: Выбор параметров инстанса**

Перед созданием инстанса необходимо определить основные параметры.

```
openstack image list
```

Выбрать нужный образ (например, `Ubuntu 22.04`) и скопировать его **ID**.

#### **2. Получение списка доступных flavor (конфигураций)**

```
openstack flavor list
```

Выбрать подходящий размер инстанса (например, `m1.small`).

#### **3. Получение списка сетей**

```
openstack network list
```

Выбрать нужную сеть (например, `private`).

#### **4. Получение списка SSH-ключей**

```
openstack keypair list
```

Если SSH-ключа нет, создать новый:

```
openstack keypair create my-key > my-key.pem
```

chmod `600 my-key.pem`

#### **5. Получение списка групп безопасности**

```
openstack security group list
```

Обычно используется `default`, но можно создать новую группу.

----------

### **Шаг 4: Создание инстанса**

Выполнить команду, заменив `<image_id>`, `<flavor_id>`, `<network_id>` и `<security_group>` на свои значения:

```
openstack server create --image <image_id> \
                        --flavor <flavor_id> \
                        --network <network_id> \
                        --security-group default \
                        --key-name my-key \
                        --wait \
                        my-instance

```

После выполнения команды отобразится информация о созданном инстансе.

----------

### **Шаг 5: Назначение плавающего IP (если нужен доступ извне)**

1.  Получить список доступных IP-адресов:

```
openstack floating ip list
```

Если свободных IP нет, выделить новый:

```
openstack floating ip create public
```

2.  Привязать IP к инстансу:

```
openstack server add floating ip my-instance <floating_ip>
```

----------

### **Шаг 6: Проверка состояния инстанса**

Убедиться, что инстанс работает:

```
openstack server list
```

Если статус `ACTIVE`, сервер запущен.

----------

### **Шаг 7: Подключение к инстансу**

#### **1. Если есть плавающий IP:**

```
ssh -i my-key.pem ubuntu@<floating_ip>
```

#### **2. Если IP нет (используем консоль OpenStack):**

```
openstack console url show my-instance
```

Откроется веб-консоль для управления сервером.

----------

Инстанс успешно создан и доступен для работы. При необходимости можно установить дополнительные пакеты и настроить сервисы.

# **Управление хостами в Zabbix**

## **1. Добавление хоста в мониторинг Zabbix**

### **Шаг 1: Вход в Zabbix Web UI**

1.  Открыть браузер и перейти на веб-интерфейс Zabbix (`http://<zabbix-server-ip>/zabbix`).
2.  Ввести **логин** и **пароль** администратора.
3.  Перейти в **"Конфигурация" → "Хосты"**.
4.  Нажать **"Создать хост"**.

### **Шаг 2: Настройка параметров хоста**

1.  **Имя хоста** – задать уникальное имя (например, `server-01`).
2.  **Группы** – выбрать или создать группу (например, `Linux Servers`).
3.  **Интерфейсы** – указать способ мониторинга:

-   **Агент Zabbix** – если установлен агент (`IP-адрес: 10050`).
-   **SNMP** – если используется SNMP (`161/UDP`).
-   **IPMI** – если доступен IPMI-контроль (`623/UDP`).
-   **JMX** – для Java-приложений (`10052`).

5.  **Шаблоны** – добавить стандартные шаблоны:

-   `Template OS Linux by Zabbix agent` – для Linux-серверов.
-   `Template OS Windows by Zabbix agent` – для Windows-серверов.
-   `Template SNMP Interfaces` – для SNMP-устройств.

7.  Нажать **"Добавить"**.

### **Шаг 3: Проверка работы агента**

1.  Перейти в **"Мониторинг" → "Последние данные"**.
2.  Найти хост, убедиться, что метрики собираются (значения обновляются).

----------

## **2. Вывод хоста из мониторинга Zabbix**

### **Метод 1: Отключение хоста без удаления**

1.  Перейти в **"Конфигурация" → "Хосты"**.
2.  Найти хост, нажать **"Отключить"** (меняется статус).
3.  Хост останется в базе, но сбор данных остановится.

### **Метод 2: Полное удаление хоста**

1.  В **"Конфигурация" → "Хосты"** отметить нужный хост.
2.  Нажать **"Удалить"**.
3.  Подтвердить действие.

----------

## **3. Добавление пользовательских метрик в Zabbix**

### **Шаг 1: Создание пользовательского элемента данных (Item)**

1.  Перейти в **"Конфигурация" → "Хосты"**.
2.  Выбрать хост, перейти во вкладку **"Элементы"**.
3.  Нажать **"Создать элемент"**.
4.  Указать параметры:

-   **Имя** – `CPU Load Custom`.
-   **Ключ** – `system.cpu.load[all,avg1]`.
-   **Тип** – `Zabbix` `агент` (или  `UserParameter`).
-   **Интервал обновления** – например, `30s`.

6.  Нажать **"Добавить"**.

### **Шаг 2: Добавление триггера для метрики**

1.  Перейти в **"Конфигурация" → "Хосты" → "Триггеры"**.
2.  Нажать **"Создать триггер"**.
3.  Указать:

-   **Имя** – `Высокая загрузка CPU`.
-   **Выражение** – `{server-01:system.cpu.load[all,avg1].last()} > 5`.
-   **Приоритет** – `Высокий`.

5.  Нажать **"Добавить"**.

### **Шаг 3: Проверка метрики**

1.  Перейти в **"Мониторинг" → "Последние данные"**.
2.  Найти новую метрику и проверить её обновление.

----------

## **4. Автоматизация добавления хостов и метрик**

### **Метод 1: Автообнаружение (Discovery)**

1.  Перейти в **"Конфигурация" → "Автообнаружение"**.
2.  Нажать **"Создать правило"**.
3.  Указать:

-   **Диапазон IP-адресов** – `192.168.1.0/24`.
-   **Метод обнаружения** – `Zabbix Agent` или `SNMP`.
-   **Действие** – добавить в группу и назначить шаблоны.

5.  Нажать **"Сохранить"**.

### **Метод 2: Автоматизация через API**

Можно использовать Zabbix API для массового добавления хостов:


    curl -X POST -H "Content-Type: application/json" -d '
    {
        "jsonrpc": "2.0",
        "method": "host.create",
        "params": {
            "host": "server-01",
            "interfaces": [{
                "type": 1,
                "main": 1,
                "useip": 1,
                "ip": "192.168.1.100",
                "dns": "",
                "port": "10050"
            }],
            "groups": [{ "groupid": "2" }],
            "templates": [{ "templateid": "10001" }]
        },
        "auth": "YOUR_API_TOKEN",
        "id": 1
    }' http://<zabbix-server>/api_jsonrpc.php

Этот скрипт автоматически добавит хост через API.

### **Метод 3: Использование Ansible для добавления хостов**

1.  Установить модуль Zabbix в Ansible:

```
pip install zabbix-api
```

2.  Создать плейбук `zabbix_add_host.yml`:

-  name:  Добавление  хоста  в  Zabbix

```
- name: Добавление хоста в Zabbix
  hosts: localhost
  tasks:
    - name: Добавить хост
      community.zabbix.zabbix_host:
        server_url: "http://zabbix-server/zabbix"
        login_user: "Admin"
        login_password: "zabbix"
        host_name: "server-01"
        host_groups:
          - "Linux Servers"
        link_templates:
          - "Template OS Linux"
        interfaces:
          - type: 1
            main: 1
            use_ip: 1
            ip: "192.168.1.100"
            dns: ""
            port: "10050"
      
```

3.  Запустить команду:

```
ansible-playbook zabbix_add_host.yml
```

----------

